
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Compliant Kubernetes is a Kubernetes distribution that reduces the burden for complying with HIPAA, Swedish Healthcare (Patientdatalagen), GDPR and ISO 27001.">
      
      
      
        <meta name="author" content="Elastisys AB">
      
      
        <link rel="canonical" href="https://compliantkubernetes.io/operator-manual/aws/">
      
      <link rel="shortcut icon" href="../../img/favicon.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-6.2.8">
    
    
      
        <title>On AWS - Compliant Kubernetes</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.cb6bc1d0.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.39b8e14a.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
    
      
        
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-68368435-4","auto"),ga("set","anonymizeIp",!0),ga("send","pageview"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){if(this.value){var e=document.location.pathname;ga("send","pageview",e+"?q="+this.value)}})}),document.addEventListener("DOMContentSwitch",function(){ga("send","pageview",document.location.pathname)})</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
      
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
      
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#compliant-kubernetes-deployment-on-aws" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid" aria-label="Header">
    <a href="https://compliantkubernetes.io" title="Compliant Kubernetes" class="md-header-nav__button md-logo" aria-label="Compliant Kubernetes">
      
  <img src="../../img/logo.png" alt="logo">

    </a>
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header-nav__title" data-md-component="header-title">
      <div class="md-header-nav__ellipsis">
        <div class="md-header-nav__topic">
          <span class="md-ellipsis">
            Compliant Kubernetes
          </span>
        </div>
        <div class="md-header-nav__topic">
          <span class="md-ellipsis">
            
              On AWS
            
          </span>
        </div>
      </div>
    </div>
    
      <label class="md-header-nav__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header-nav__source">
        
<a href="https://github.com/elastisys/compliantkubernetes/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    




<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="https://compliantkubernetes.io" title="Compliant Kubernetes" class="md-nav__button md-logo" aria-label="Compliant Kubernetes">
      
  <img src="../../img/logo.png" alt="logo">

    </a>
    Compliant Kubernetes
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/elastisys/compliantkubernetes/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Overview
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../compliance/" class="md-nav__link">
        Compliance Basics
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/" class="md-nav__link">
        Core Concepts
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../getting-started/" class="md-nav__link">
        Getting Started
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../benefits/" class="md-nav__link">
        Exploring Benefits
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="nav-6" type="checkbox" id="nav-6" >
      
      <label class="md-nav__link" for="nav-6">
        User Guide
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="User Guide" data-md-level="1">
        <label class="md-nav__title" for="nav-6">
          <span class="md-nav__icon md-icon"></span>
          User Guide
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guide/" class="md-nav__link">
        Overview
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guide/harbor/" class="md-nav__link">
        Harbor
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guide/kubernetes-api/" class="md-nav__link">
        Kubernetes API
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guide/elasticsearch/" class="md-nav__link">
        Elasticsearch/Kibana
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guide/prometheus/" class="md-nav__link">
        Prometheus/Grafana
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guide/dashboard/" class="md-nav__link">
        Dashboard
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guide/backup/" class="md-nav__link">
        Backups
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="nav-7" type="checkbox" id="nav-7" >
      
      <label class="md-nav__link" for="nav-7">
        CISO Guide
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="CISO Guide" data-md-level="1">
        <label class="md-nav__title" for="nav-7">
          <span class="md-nav__icon md-icon"></span>
          CISO Guide
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../ciso-guide/" class="md-nav__link">
        Overview
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../ciso-guide/backup/" class="md-nav__link">
        Backup
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../ciso-guide/cryptography/" class="md-nav__link">
        Cryptography
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../ciso-guide/intrusion-detection/" class="md-nav__link">
        Intrusion Detection
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../ciso-guide/policy-as-code/" class="md-nav__link">
        Policy-as-Code
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="nav-8" type="checkbox" id="nav-8" checked>
      
      <label class="md-nav__link" for="nav-8">
        Operator Manual
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Operator Manual" data-md-level="1">
        <label class="md-nav__title" for="nav-8">
          <span class="md-nav__icon md-icon"></span>
          Operator Manual
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../" class="md-nav__link">
        Overview
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../getting-started/" class="md-nav__link">
        Getting Started
      </a>
    </li>
  

          
            
  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="nav-8-3" type="checkbox" id="nav-8-3" checked>
      
      <label class="md-nav__link" for="nav-8-3">
        Creating/Destroying/Upgrading a Cluster
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Creating/Destroying/Upgrading a Cluster" data-md-level="2">
        <label class="md-nav__title" for="nav-8-3">
          <span class="md-nav__icon md-icon"></span>
          Creating/Destroying/Upgrading a Cluster
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
          
            
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          On AWS
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        On AWS
      </a>
      
        
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#setup" class="md-nav__link">
    Setup
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deploying-vanilla-kubernetes-clusters" class="md-nav__link">
    Deploying vanilla Kubernetes clusters
  </a>
  
    <nav class="md-nav" aria-label="Deploying vanilla Kubernetes clusters">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#infrastructure-setup-using-terraform" class="md-nav__link">
    Infrastructure Setup using Terraform
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deploying-vanilla-kubernetes-clusters-using-kubespray" class="md-nav__link">
    Deploying vanilla Kubernetes clusters using Kubespray.
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deploying-compliant-kubernetes-apps" class="md-nav__link">
    Deploying Compliant Kubernetes Apps
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#teardown" class="md-nav__link">
    Teardown
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#further-reading" class="md-nav__link">
    Further Reading
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../exoscale/" class="md-nav__link">
        On Exoscale
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="nav-8-4" type="checkbox" id="nav-8-4" >
      
      <label class="md-nav__link" for="nav-8-4">
        Configuring a Cluster
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Configuring a Cluster" data-md-level="2">
        <label class="md-nav__title" for="nav-8-4">
          <span class="md-nav__icon md-icon"></span>
          Configuring a Cluster
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../overview/" class="md-nav__link">
        Overview
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../ingress/" class="md-nav__link">
        Ingress
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../disaster-recovery/" class="md-nav__link">
        Disaster Recovery
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../break-glass/" class="md-nav__link">
        Breaking the Glass
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="nav-9" type="checkbox" id="nav-9" >
      
      <label class="md-nav__link" for="nav-9">
        Developer Guide
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Developer Guide" data-md-level="1">
        <label class="md-nav__title" for="nav-9">
          <span class="md-nav__icon md-icon"></span>
          Developer Guide
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../adr/" class="md-nav__link">
        Architectural Decision Log
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../faq/" class="md-nav__link">
        FAQ
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../roadmap/" class="md-nav__link">
        Roadmap
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="https://compliantkubernetes.com/" class="md-nav__link">
        Support ⧉
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="https://elastisys.com/blog/" class="md-nav__link">
        Blog ⧉
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#setup" class="md-nav__link">
    Setup
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deploying-vanilla-kubernetes-clusters" class="md-nav__link">
    Deploying vanilla Kubernetes clusters
  </a>
  
    <nav class="md-nav" aria-label="Deploying vanilla Kubernetes clusters">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#infrastructure-setup-using-terraform" class="md-nav__link">
    Infrastructure Setup using Terraform
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deploying-vanilla-kubernetes-clusters-using-kubespray" class="md-nav__link">
    Deploying vanilla Kubernetes clusters using Kubespray.
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deploying-compliant-kubernetes-apps" class="md-nav__link">
    Deploying Compliant Kubernetes Apps
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#teardown" class="md-nav__link">
    Teardown
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#further-reading" class="md-nav__link">
    Further Reading
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/elastisys/compliantkubernetes/edit/main/docs/operator-manual/aws.md" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                <h1 id="compliant-kubernetes-deployment-on-aws">Compliant Kubernetes Deployment on AWS</h1>
<p>This document describes how to set up Compliant Kubernetes on AWS. The setup has two major parts:</p>
<ol>
<li>Deploying at least two vanilla Kubernetes clusters</li>
<li>Deploying Compliant Kubernetes apps</li>
</ol>
<p>Before starting, make sure you have <a href="../getting-started/">all necessary tools</a>.</p>
<h2 id="setup">Setup</h2>
<p>Choose names for your service cluster and workload clusters, as well as the DNS domain to expose the services inside the service cluster:</p>
<div class="highlight"><pre><span></span><code><span class="nv">SERVICE_CLUSTER</span><span class="o">=</span><span class="s2">&quot;testsc&quot;</span>
<span class="nv">WORKLOAD_CLUSTERS</span><span class="o">=</span><span class="s2">&quot;testwc0&quot;</span>
<span class="nv">BASE_DOMAIN</span><span class="o">=</span><span class="s2">&quot;example.com&quot;</span>
</code></pre></div>
<h2 id="deploying-vanilla-kubernetes-clusters">Deploying vanilla Kubernetes clusters</h2>
<p>We suggest to set up Kubernetes clusters using kubespray. If you haven't done so already, clone the Elastisys Compliant Kubernetes Kubespray repo as follows:</p>
<div class="highlight"><pre><span></span><code>git clone --recursive https://github.com/elastisys/compliantkubernetes-kubespray
<span class="nb">cd</span> compliantkubernetes-kubespray
</code></pre></div>
<h3 id="infrastructure-setup-using-terraform">Infrastructure Setup using Terraform</h3>
<ol>
<li>
<p>Expose AWS credentials to Terraform.</p>
<p>We suggest exposing AWS credentials to Terraform via environment variables, so they are not accidentally left on the file-system:</p>
<div class="highlight"><pre><span></span><code><span class="nb">export</span> <span class="nv">TF_VAR_AWS_ACCESS_KEY_ID</span><span class="o">=</span><span class="s2">&quot;www&quot;</span>
<span class="nb">export</span> <span class="nv">TF_VAR_AWS_SECRET_ACCESS_KEY</span><span class="o">=</span><span class="s2">&quot;xxx&quot;</span>
<span class="nb">export</span> <span class="nv">TF_VAR_AWS_SSH_KEY_NAME</span><span class="o">=</span><span class="s2">&quot;yyy&quot;</span>
<span class="nb">export</span> <span class="nv">TF_VAR_AWS_DEFAULT_REGION</span><span class="o">=</span><span class="s2">&quot;zzz&quot;</span>
</code></pre></div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>We suggest generating the SSH key locally, then importing it to AWS.</p>
</div>
</li>
<li>
<p>Customize your infrastructure.</p>
<p>Create a configuration for the service cluster and the workload cluster:</p>
<div class="highlight"><pre><span></span><code><span class="nb">pushd</span> kubespray
<span class="k">for</span> CLUSTER <span class="k">in</span> <span class="nv">$SERVICE_CLUSTER</span> <span class="nv">$WORKLOAD_CLUSTERS</span><span class="p">;</span> <span class="k">do</span>
    cat contrib/terraform/aws/terraform.tfvars <span class="se">\</span>
    <span class="p">|</span> sed <span class="se">\</span>
        -e <span class="s2">&quot;s@^aws_cluster_name =.*@aws_cluster_name = \&quot;</span><span class="nv">$CLUSTER</span><span class="s2">\&quot;@&quot;</span> <span class="se">\</span>
        -e <span class="s2">&quot;s@^inventory_file =.*@inventory_file = \&quot;../../../inventory/hosts-</span><span class="nv">$CLUSTER</span><span class="s2">\&quot;@&quot;</span> <span class="se">\</span>
        -e <span class="s2">&quot;s@^aws_kube_worker_size =.*@aws_kube_worker_size = \&quot;t3.large\&quot;@&quot;</span> <span class="se">\</span>
    &gt; inventory/terraform-<span class="nv">$CLUSTER</span>.tfvars
<span class="k">done</span>
<span class="nb">popd</span>
</code></pre></div>
<p>Review and, if needed, adjust the files in <code>kubespray/inventory/</code>.</p>
</li>
<li>
<p>Initialize and Apply Terraform.</p>
<div class="highlight"><pre><span></span><code><span class="nb">pushd</span> kubespray/contrib/terraform/aws
terraform init
<span class="k">for</span> CLUSTER <span class="k">in</span> <span class="nv">$SERVICE_CLUSTER</span> <span class="nv">$WORKLOAD_CLUSTERS</span><span class="p">;</span> <span class="k">do</span>
    terraform apply <span class="se">\</span>
        -var-file<span class="o">=</span>../../../inventory/terraform-<span class="nv">$CLUSTER</span>.tfvars <span class="se">\</span>
        -auto-approve <span class="se">\</span>
        -state<span class="o">=</span>../../../inventory/tfstate-<span class="nv">$CLUSTER</span>.tfstate
<span class="k">done</span>
<span class="nb">popd</span>
</code></pre></div>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>The Terraform state is stored in <code>kubespray/inventory/tfstate-*</code>. It is precious. Consider backing it up or using <a href="https://www.terraform.io/docs/cloud/index.html">Terraform Cloud</a>.</p>
</div>
</li>
<li>
<p>Check that the Ansible inventory was properly generated.</p>
<div class="highlight"><pre><span></span><code>ls -l kubespray/inventory/hosts-*
</code></pre></div>
<p>You may also want to check the AWS Console if the infrastructure was created correctly:</p>
<p><img alt="Kubespray AWS Console" src="../../img/kubespray-aws-console.png" /></p>
</li>
</ol>
<h3 id="deploying-vanilla-kubernetes-clusters-using-kubespray">Deploying vanilla Kubernetes clusters using Kubespray.</h3>
<p>With the infrastructure provisioned, we can now deploy both the sc and wc Kubernetes clusters using kubespray. Before trying any of the steps, make sure you are in the repo's root folder.</p>
<ol>
<li>
<p>Init the Kubespray config in your config path.</p>
<div class="highlight"><pre><span></span><code><span class="nb">export</span> <span class="nv">CK8S_CONFIG_PATH</span><span class="o">=</span>~/.ck8s/aws
<span class="nb">export</span> <span class="nv">CK8S_PGP_FP</span><span class="o">=</span>&lt;your GPG key ID&gt;  <span class="c1"># retrieve with gpg --list-secret-keys</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>for CLUSTER in $SERVICE_CLUSTER $WORKLOAD_CLUSTERS; do
    ./bin/ck8s-kubespray init $CLUSTER default ~/.ssh/id_rsa.pub

    # This parts needs refactoring, in the meanwhile:
    sed -e &#39;s@^---$@@&#39; -i $CK8S_CONFIG_PATH/$CLUSTER-config/group_vars/all/all.yml
    sed -e &#39;s@^---$@@&#39; -i $CK8S_CONFIG_PATH/$CLUSTER-config/group_vars/k8s-cluster/k8s-cluster.yml
    sed -e &#39;s@^etcd_kubeadm_enabled:.*@#etcd_kubeadm_enabled: false@&#39; -i $CK8S_CONFIG_PATH/$CLUSTER-config/group_vars/all/all.yml
    echo &#39;ansible_user: ubuntu&#39; &gt;&gt; $CK8S_CONFIG_PATH/$CLUSTER-config/group_vars/all/all.yml
    sed -e &#39;s@.*[^_]cloud_provider:.*@cloud_provider: aws@&#39; -i $CK8S_CONFIG_PATH/$CLUSTER-config/group_vars/all/all.yml
    sed -e &quot;s@.*kube_oidc_auth:.*@kube_oidc_auth: true@&quot; -i $CK8S_CONFIG_PATH/$CLUSTER-config/group_vars/k8s-cluster/k8s-cluster.yml
    sed -e &quot;s@.*kube_oidc_url:.*@kube_oidc_url: https://dex.$BASE_DOMAIN@&quot; -i $CK8S_CONFIG_PATH/$CLUSTER-config/group_vars/k8s-cluster/k8s-cluster.yml
    sed -e &quot;s@.*kube_oidc_client_id:.*@kube_oidc_client_id: kubelogin@&quot; -i $CK8S_CONFIG_PATH/$CLUSTER-config/group_vars/k8s-cluster/k8s-cluster.yml
    sed -e &quot;s@.*kube_oidc_username_claim:.*@kube_oidc_username_claim: email@&quot; -i $CK8S_CONFIG_PATH/$CLUSTER-config/group_vars/k8s-cluster/k8s-cluster.yml
done
</code></pre></div>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>The key in <code>~/.ssh/id_rsa.pub</code> must match the key referenced in <code>TF_VAR_AWS_SSH_KEY_NAME</code> above.</p>
</div>
</li>
<li>
<p>Copy the inventories generated by Terraform above in the right place.</p>
<div class="highlight"><pre><span></span><code><span class="k">for</span> CLUSTER <span class="k">in</span> <span class="nv">$SERVICE_CLUSTER</span> <span class="nv">$WORKLOAD_CLUSTERS</span><span class="p">;</span> <span class="k">do</span>
    cp kubespray/inventory/hosts-<span class="nv">$CLUSTER</span> <span class="nv">$CK8S_CONFIG_PATH</span>/<span class="nv">$CLUSTER</span>-config/inventory.ini
<span class="k">done</span>
</code></pre></div>
</li>
<li>
<p>Run kubespray to deploy the Kubernetes clusters.</p>
<div class="highlight"><pre><span></span><code><span class="k">for</span> CLUSTER <span class="k">in</span> <span class="nv">$SERVICE_CLUSTER</span> <span class="nv">$WORKLOAD_CLUSTERS</span><span class="p">;</span> <span class="k">do</span>
    ./bin/ck8s-kubespray apply <span class="nv">$CLUSTER</span> --flush-cache
<span class="k">done</span>
</code></pre></div>
<p>This may take up to 20 minutes.</p>
</li>
<li>
<p>Correct the Kubernetes API IP addresses.</p>
<p>Find the DNS names of the load balancers fronting the API servers:</p>
<div class="highlight"><pre><span></span><code>grep apiserver_loadbalancer <span class="nv">$CK8S_CONFIG_PATH</span>/*-config/inventory.ini
</code></pre></div>
<p>Locate the encrypted kubeconfigs <code>kube_config_*.yaml</code> and edit them using sops. Copy the URL of the load balancer from inventory files shown above into <code>kube_config_*.yaml</code>. Do not overwrite the port.</p>
<div class="highlight"><pre><span></span><code><span class="k">for</span> CLUSTER <span class="k">in</span> <span class="nv">$SERVICE_CLUSTER</span> <span class="nv">$WORKLOAD_CLUSTERS</span><span class="p">;</span> <span class="k">do</span>
    sops <span class="nv">$CK8S_CONFIG_PATH</span>/.state/kube_config_<span class="nv">$CLUSTER</span>.yaml
<span class="k">done</span>
</code></pre></div>
</li>
<li>
<p>Test access to the clusters as follows:</p>
<div class="highlight"><pre><span></span><code><span class="k">for</span> CLUSTER <span class="k">in</span> <span class="nv">$SERVICE_CLUSTER</span> <span class="nv">$WORKLOAD_CLUSTERS</span><span class="p">;</span> <span class="k">do</span>
    sops exec-file <span class="nv">$CK8S_CONFIG_PATH</span>/.state/kube_config_<span class="nv">$CLUSTER</span>.yaml <span class="se">\</span>
        <span class="s1">&#39;kubectl --kubeconfig {} get nodes&#39;</span>
<span class="k">done</span>
</code></pre></div>
</li>
</ol>
<h2 id="deploying-compliant-kubernetes-apps">Deploying Compliant Kubernetes Apps</h2>
<p>Now that the Kubernetes clusters are up and running, we are ready to install the Compliant Kubernetes apps.</p>
<ol>
<li>
<p>If you haven't done so already, clone the Compliant Kubernetes apps repo and install pre-requisites.</p>
<div class="highlight"><pre><span></span><code>git clone https://github.com/elastisys/compliantkubernetes-apps.git
<span class="nb">cd</span> compliantkubernetes-apps
ansible-playbook -e <span class="s1">&#39;ansible_python_interpreter=/usr/bin/python3&#39;</span> --ask-become-pass --connection <span class="nb">local</span> --inventory <span class="m">127</span>.0.0.1, get-requirements.yaml
</code></pre></div>
</li>
<li>
<p>Initialize the apps configuration.</p>
<div class="highlight"><pre><span></span><code><span class="nb">export</span> <span class="nv">CK8S_ENVIRONMENT_NAME</span><span class="o">=</span>aws
<span class="c1">#export CK8S_FLAVOR=[dev|prod] # defaults to dev</span>
<span class="nb">export</span> <span class="nv">CK8S_CONFIG_PATH</span><span class="o">=</span>~/.ck8s/aws
<span class="nb">export</span> <span class="nv">CK8S_CLOUD_PROVIDER</span><span class="o">=</span>aws
<span class="nb">export</span> <span class="nv">CK8S_PGP_FP</span><span class="o">=</span>&lt;your GPG key ID&gt;  <span class="c1"># retrieve with gpg --list-secret-keys</span>
./bin/ck8s init
</code></pre></div>
<p>Three  files, <code>sc-config.yaml</code> and <code>wc-config.yaml</code>, and <code>secrets.yaml</code>, were generated in the <code>$CK8S_CONFIG_PATH</code> directory.</p>
<div class="highlight"><pre><span></span><code>ls -l <span class="nv">$CK8S_CONFIG_PATH</span>
</code></pre></div>
</li>
<li>
<p>Configure the apps.</p>
<p>Edit the configuration files <code>sc-config.yaml</code>, <code>wc-config.yaml</code> and <code>secrets.yaml</code> and set the appropriate values for some of the configuration fields. Note that, the latter is encrypted.</p>
<div class="highlight"><pre><span></span><code>vim <span class="nv">$CK8S_CONFIG_PATH</span>/sc-config.yaml
vim <span class="nv">$CK8S_CONFIG_PATH</span>/wc-config.yaml
sops <span class="nv">$CK8S_CONFIG_PATH</span>/secrets.yaml
</code></pre></div>
<p>The following are the minimum change you should perform:</p>
<div class="highlight"><pre><span></span><code># sc-config.yaml and wc-config.yaml
global:
  baseDomain: &quot;set-me&quot;  # set to $BASE_DOMAIN
  opsDomain: &quot;set-me&quot;  # set to ops.$BASE_DOMAIN
  issuer: letsencrypt-prod

objectStorage:
  type: &quot;s3&quot;
  s3:
    region: &quot;set-me&quot;  # Region for S3 buckets, e.g, eu-central-1
    regionAddress: &quot;set-me&quot;  # Region address, e.g, s3.eu-central-1.amazonaws.com
    regionEndpoint: &quot;set-me&quot;  # e.g., https://s3.us-west-1.amazonaws.com

fluentd:
  forwarder:
    useRegionEndpoint: &quot;set-me&quot;  # set it to either true or false

issuers:
  letsencrypt:
    email: &quot;set-me&quot;  # set this to an email to receive LetsEncrypt notifications
</code></pre></div>
<div class="highlight"><pre><span></span><code># secrets.yaml
objectStorage:
  s3:
    accessKey: &quot;set-me&quot; #put your s3 accesskey
    secretKey: &quot;set-me&quot; #put your s3 secretKey
</code></pre></div>
</li>
<li>
<p>Create placeholder DNS entries.</p>
<p>To avoid negative caching and other surprises. Create two placeholders as follows (feel free to use the "Import zone" feature of AWS Route53):</p>
<div class="highlight"><pre><span></span><code>echo &quot;
*.$BASE_DOMAIN     60s A 203.0.113.123
*.ops.$BASE_DOMAIN 60s A 203.0.113.123
&quot;
</code></pre></div>
<p>NOTE: 203.0.113.123 is in <a href="https://en.wikipedia.org/wiki/Reserved_IP_addresses">TEST-NET-3</a> and okey to use as placeholder.</p>
</li>
<li>
<p>Installing Compliant Kubernetes apps.</p>
<p>Start with the service cluster:</p>
<div class="highlight"><pre><span></span><code>ln -sf <span class="nv">$CK8S_CONFIG_PATH</span>/.state/kube_config_<span class="si">${</span><span class="nv">SERVICE_CLUSTER</span><span class="si">}</span>.yaml <span class="nv">$CK8S_CONFIG_PATH</span>/.state/kube_config_sc.yaml
./bin/ck8s apply sc  <span class="c1"># Respond &quot;n&quot; if you get a WARN</span>
</code></pre></div>
<p>Then the workload clusters:
<div class="highlight"><pre><span></span><code>for CLUSTER in $WORKLOAD_CLUSTERS; do
    ln -sf $CK8S_CONFIG_PATH/.state/kube_config_${CLUSTER}.yaml $CK8S_CONFIG_PATH/.state/kube_config_wc.yaml
    ./bin/ck8s apply wc  # Respond &quot;n&quot; if you get a WARN
done
</code></pre></div></p>
<p><strong>NOTE: Leave sufficient time for the system to settle, e.g., request TLS certificates from LetsEncrypt, perhaps as much as 20 minutes.</strong></p>
</li>
<li>
<p>Setup required DNS entries.</p>
<p>You will need to set up the following DNS entries. First, determine the public IP of the load-balancer fronting the Ingress controller of the <em>service cluster</em>:</p>
<div class="highlight"><pre><span></span><code>SC_INGRESS_LB_HOSTNAME=$(sops exec-file $CK8S_CONFIG_PATH/.state/kube_config_sc.yaml &#39;kubectl --kubeconfig {} get -n ingress-nginx svc ingress-nginx-controller -o jsonpath={.status.loadBalancer.ingress[0].hostname}&#39;)
SC_INGRESS_LB_IP=$(dig +short $SC_INGRESS_LB_HOSTNAME | head -1)
echo $SC_INGRESS_LB_IP
</code></pre></div>
<p>Then, import the following zone in AWS Route53:</p>
<div class="highlight"><pre><span></span><code>echo &quot;&quot;&quot;
*.ops.$BASE_DOMAIN    60s A $SC_INGRESS_LB_IP
dex.$BASE_DOMAIN      60s A $SC_INGRESS_LB_IP
grafana.$BASE_DOMAIN  60s A $SC_INGRESS_LB_IP
harbor.$BASE_DOMAIN   60s A $SC_INGRESS_LB_IP
kibana.$BASE_DOMAIN   60s A $SC_INGRESS_LB_IP
&quot;&quot;&quot;
</code></pre></div>
</li>
<li>
<p>Testing:</p>
<p>After completing the installation step you can test if the apps are properly installed and ready using the commands below.</p>
<div class="highlight"><pre><span></span><code>./bin/ck8s <span class="nb">test</span> sc
<span class="k">for</span> CLUSTER <span class="k">in</span> <span class="nv">$WORKLOAD_CLUSTERS</span><span class="p">;</span> <span class="k">do</span>
    ln -sf <span class="nv">$CK8S_CONFIG_PATH</span>/.state/kube_config_<span class="si">${</span><span class="nv">CLUSTER</span><span class="si">}</span>.yaml <span class="nv">$CK8S_CONFIG_PATH</span>/.state/kube_config_wc.yaml
    ./bin/ck8s <span class="nb">test</span> wc
<span class="k">done</span>
</code></pre></div>
</li>
</ol>
<p>Done. Navigate to <code>grafana.$BASE_DOMAIN</code>, <code>kibana.$BASE_DOMAIN</code>, <code>harbor.$BASE_DOMAIN</code>, etc. to discover Compliant Kubernetes's features.</p>
<h2 id="teardown">Teardown</h2>
<div class="highlight"><pre><span></span><code><span class="k">for</span> CLUSTER <span class="k">in</span> <span class="nv">$WORKLOAD_CLUSTERS</span> <span class="nv">$SERVICE_CLUSTER</span><span class="p">;</span> <span class="k">do</span>
    sops exec-file <span class="nv">$CK8S_CONFIG_PATH</span>/.state/kube_config_<span class="nv">$CLUSTER</span>.yaml <span class="se">\</span>
        <span class="s1">&#39;kubectl --kubeconfig {} delete --all-namespaces --all ingress,service,deployment,statefulset,daemonset,cronjob,job,pod,sa,secret,configmap&#39;</span>
<span class="k">done</span>

<span class="c1"># Feel free to skips this step, but remember to remove EBS volumes manually</span>
<span class="c1"># from the AWS Console, after Terraform teardown.</span>
<span class="k">for</span> CLUSTER <span class="k">in</span> <span class="nv">$WORKLOAD_CLUSTERS</span> <span class="nv">$SERVICE_CLUSTER</span><span class="p">;</span> <span class="k">do</span>
    sops exec-file <span class="nv">$CK8S_CONFIG_PATH</span>/.state/kube_config_<span class="nv">$CLUSTER</span>.yaml <span class="se">\</span>
        <span class="s1">&#39;kubectl --kubeconfig {} delete --all-namespaces --all pvc,pv&#39;</span>
<span class="k">done</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="nb">cd</span> ../compliantkubernetes-kubespray
<span class="nb">pushd</span> kubespray/contrib/terraform/aws
<span class="k">for</span> CLUSTER <span class="k">in</span> <span class="nv">$SERVICE_CLUSTER</span> <span class="nv">$WORKLOAD_CLUSTERS</span><span class="p">;</span> <span class="k">do</span>
    terraform destroy <span class="se">\</span>
        -auto-approve <span class="se">\</span>
        -state<span class="o">=</span>../../../inventory/tfstate-<span class="nv">$CLUSTER</span>.tfstate
<span class="k">done</span>
<span class="nb">popd</span>
</code></pre></div>
<h2 id="further-reading">Further Reading</h2>
<ul>
<li><a href="https://github.com/elastisys/compliantkubernetes-apps">Compliant Kubernetes apps repo</a></li>
<li><a href="https://github.com/elastisys/compliantkubernetes-apps#elastisys-compliant-kubernetes-apps">Configurations option</a></li>
</ul>
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid" aria-label="Footer">
        
          <a href="../getting-started/" class="md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
            </div>
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Getting Started
              </div>
            </div>
          </a>
        
        
          <a href="../exoscale/" class="md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                On Exoscale
              </div>
            </div>
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Copyright © 2020 Elastisys AB
          </div>
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/vendor.18f0862e.min.js"></script>
      <script src="../../assets/javascripts/bundle.994580cf.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing"}</script>
      
      <script>
        app = initialize({
          base: "../..",
          features: [],
          search: Object.assign({
            worker: "../../assets/javascripts/worker/search.9c0e82ba.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
    
  </body>
</html>